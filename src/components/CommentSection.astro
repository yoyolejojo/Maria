---
interface Props {
  postSlug: string;
}

const { postSlug } = Astro.props;
---

<div class="comment-section">
  <h2>Flop ou pas Flop ?</h2>
    
    <!-- Note moyenne -->
    <div class="average-rating">
      
      <div id="average-stars" class="stars-display">
        <span class="loading">Chargement...</span>
      </div>
      <span id="rating-count"></span>
  </div>
  <!-- Formulaire pour ajouter un commentaire -->
  <div class="comment-form">
    <h3>Alors ?</h3>
    <form id="comment-form">
      <input type="hidden" id="post-slug" value={postSlug} />
      
      <div class="form-group">
        <label for="auteur">Pseudo :</label>
        <input type="text" id="auteur" required maxlength="50" />
      </div>
      
      <div class="form-group">
        <label for="note">Ta note :</label>
        <div class="stars">
          <input type="radio" id="star5" name="note" value="5" required />
          <label for="star5">‚≠ê</label>
          <input type="radio" id="star4" name="note" value="4" />
          <label for="star4">‚≠ê</label>
          <input type="radio" id="star3" name="note" value="3" />
          <label for="star3">‚≠ê</label>
          <input type="radio" id="star2" name="note" value="2" />
          <label for="star2">‚≠ê</label>
          <input type="radio" id="star1" name="note" value="1" />
          <label for="star1">‚≠ê</label>
        </div>
      </div>
      
      <div class="form-group">
        <label for="commentaire">Ton commentaire :</label>
        <textarea id="commentaire" rows="4" required maxlength="500"></textarea>
      </div>
      
      <button type="submit">Publier</button>
    </form>
    <div id="message"></div>
  </div>
  
  <!-- Liste des commentaires existants -->
  <div class="comments-list">
    <h3>Avis pr√©c√©dents</h3>
    <div id="comments-container">
      <p>Chargement des commentaires...</p>
    </div>
  </div>
</div>

<style>
.comment-section {
  max-width: 800px;
  margin: 3rem auto;
  padding: 0 1rem;
}

.comment-section h2 {
  font-size: 2rem;
  margin-bottom: 2rem;
  text-align: center;
  color: #333;
}

.average-rating {
  text-align: center;
  padding: 2rem;
  background: white;
  border-radius: 20px;
  margin-bottom: 3rem;
  box-shadow: 0 5px 20px rgba(0,0,0,0.08);
  border: 2px solid #e0e0e0;
}

.average-rating h3 {
  margin-bottom: 1rem;
  font-size: 1.3rem;
  font-weight: 600;
  color: #333;
}

.stars-display .loading {
  font-size: 1rem;
  color: #666;
}

.stars-display .loading {
  font-size: 1rem;
  color: white;
}

#rating-count {
  display: block;
  color: #666;
  font-size: 1rem;
  margin-top: 0.5rem;
}

.comment-form {
  background: white;
  padding: 2.5rem;
  border-radius: 20px;
  margin-bottom: 3rem;
  box-shadow: 0 5px 20px rgba(0,0,0,0.08);
  border: 1px solid #f0f0f0;
}

.comment-form h3 {
  margin-bottom: 1.5rem;
  color: #333;
  font-size: 1.4rem;
}

.form-group {
  margin-bottom: 1.5rem;
}

label {
  display: block;
  margin-bottom: 0.5rem;
  font-weight: 600;
  color: #555;
  font-size: 0.95rem;
}

input[type="text"],
textarea {
  width: 100%;
  max-width: 100%;
  padding: 0.9rem;
  border: 2px solid #e0e0e0;
  border-radius: 12px;
  font-family: inherit;
  font-size: 1rem;
  transition: all 0.3s ease;
  background: #fafafa;
  box-sizing: border-box; /* ‚Üê Important pour √©viter le d√©passement */
}

input[type="text"]:focus,
textarea:focus {
  outline: none;
  border-color: #667eea;
  background: white;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

textarea {
  resize: vertical;
  min-height: 100px;
}

.stars {
  display: flex;
  flex-direction: row-reverse;
  justify-content: flex-end;
  gap: 0.3rem;
}

.stars input {
  display: none;
}

.stars label {
  cursor: pointer;
  font-size: 2.5rem;
  margin: 0;
  transition: all 0.2s ease;
  filter: grayscale(100%); /* ‚Üê Grise les √©toiles non s√©lectionn√©es */
  opacity: 0.3; /* ‚Üê Les rend semi-transparentes */
}

.stars label:hover,
.stars label:hover ~ label {
  filter: grayscale(0%); /* ‚Üê Enl√®ve le gris au survol */
  opacity: 1;
  transform: scale(1.1);
}

.stars input:checked ~ label {
  filter: grayscale(0%); /* ‚Üê Enl√®ve le gris quand s√©lectionn√© */
  opacity: 1;
}

button {
  background-image: url('/Leopard.jpg');
  background-size: cover;
  background-position: center;
  color: white !important;
  padding: 1rem 2.5rem;
  border: none;
  border-radius: 50px;
  cursor: pointer;
  font-size: 1.1rem;
  font-weight: 700;
  text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

button::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.3);
  z-index: 0;
  transition: all 0.3s ease;
}

button:hover::before {
  background: rgba(0, 0, 0, 0.2);
}

button:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
}

button:active {
  transform: translateY(0);
}

button:disabled {
  opacity: 0.7;
  cursor: not-allowed;
  transform: none;
}

button * {
  position: relative;
  z-index: 1;
}

#message {
  margin-top: 1.5rem;
  padding: 1rem;
  border-radius: 12px;
  font-weight: 500;
  text-align: center;
}

#message.success {
  background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
  color: #155724;
  border: 1px solid #c3e6cb;
}

#message.error {
  background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
  color: #721c24;
  border: 1px solid #f5c6cb;
}

.comments-list h3 {
  margin-bottom: 1.5rem;
  color: #333;
  font-size: 1.4rem;
}

.comment {
  background: white;
  padding: 2rem; /* ‚Üê Augment√© de 1.5rem √† 2rem */
  border-radius: 16px;
  margin-bottom: 2.5rem; /* ‚Üê Augment√© de 1.5rem √† 2.5rem pour plus d'espace entre commentaires */
  border: 2px solid #e0e0e0;
  box-shadow: 0 2px 10px rgba(0,0,0,0.05);
  transition: all 0.3s ease;
}

.comment:hover {
  box-shadow: 0 5px 20px rgba(0,0,0,0.1);
  transform: translateY(-2px);
  border-color: #667eea;
}

.comment-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.8rem;
  flex-wrap: wrap;
  gap: 0.5rem;
}

.comment-author {
  font-weight: 700;
  font-size: 1.1rem;
  color: #667eea;
}

.comment-rating {
  color: #ffc107;
  font-size: 1.2rem;
}

.comment-date {
  color: #999;
  font-size: 0.85rem;
  margin-bottom: 0.8rem;
}

.comment-text {
  margin-top: 0.8rem;
  line-height: 1.7;
  color: #555;
}

@media (max-width: 768px) {
  .comment-form {
    padding: 1.5rem;
  }
  
  .average-rating {
    padding: 1.5rem;
  }
  
  .stars-display {
    font-size: 2.5rem;
  }
  
  button {
    width: 100%;
    padding: 1rem;
  }
}
</style>

<script>
  import { supabase } from '../supabase.js';
  
  const form = document.getElementById('comment-form') as HTMLFormElement;
  const messageDiv = document.getElementById('message') as HTMLDivElement;
  const commentsContainer = document.getElementById('comments-container') as HTMLDivElement;
  const postSlug = (document.getElementById('post-slug') as HTMLInputElement).value;
  
 // Charger les commentaires existants
  async function loadComments() {
    const { data, error } = await supabase
      .from('commentaires')
      .select('*')
      .eq('post_id', postSlug)
      .order('created_at', { ascending: false });
    
    if (error) {
      commentsContainer.innerHTML = '<p>Erreur lors du chargement des commentaires.</p>';
      return;
    }
    
    // Calculer la note moyenne
    if (data.length > 0) {
     const totalNotes = data.reduce((sum, comment) => sum + comment.note, 0);
      const average = totalNotes / data.length;
      const fullStars = Math.floor(average); // Arrondi √† l'entier inf√©rieur
      const emptyStars = 5 - fullStars;
      
      // Afficher les √©toiles
      const averageStars = document.getElementById('average-stars');
      averageStars.innerHTML = 
        '‚≠ê'.repeat(fullStars) + 
        '‚òÜ'.repeat(emptyStars);
            
      document.getElementById('rating-count').textContent = 
        `${average.toFixed(1)}/5 (${data.length} avis)`;
    } else {
      document.getElementById('average-stars').innerHTML = 
        '<span class="loading" style="font-size:20px;">Pas de note</span>';
      document.getElementById('rating-count').textContent = '';
    }
    
    // Afficher les commentaires
    if (data.length === 0) {
      commentsContainer.innerHTML = "<p>T'as pas encore comment√©</p>";
      return;
    }
    
    commentsContainer.innerHTML = data.map(comment => `
      <div class="comment" style="margin-bottom: 2.5rem; padding: 2.5rem; background: white; border-radius: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.08); border: 1px solid #f0f0f0;">
        <div class="comment-header">
          <span class="comment-author">${escapeHtml(comment.auteur)}</span>
          <span class="comment-rating">${'‚≠ê'.repeat(comment.note)}${'‚òÜ'.repeat(5 - comment.note)}</span>
        </div>
        <div class="comment-date">${new Date(comment.created_at).toLocaleDateString('fr-FR')}</div>
        <div class="comment-text">${escapeHtml(comment.commentaire)}</div>
      </div>
    `).join('');
  }
    
  // Fonction pour √©chapper le HTML et √©viter les injections
  function escapeHtml(text: string) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
  // Soumettre un nouveau commentaire
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const auteur = (document.getElementById('auteur') as HTMLInputElement).value;
    const note = parseInt((document.querySelector('input[name="note"]:checked') as HTMLInputElement).value);
    const commentaire = (document.getElementById('commentaire') as HTMLTextAreaElement).value;
    
const { error } = await supabase
  .from('commentaires')
  .insert([
    { post_id: postSlug, auteur, note, commentaire }
  ]);

if (error) {
  console.error('Erreur Supabase:', error);
  messageDiv.textContent = 'Erreur : ' + error.message;
  messageDiv.className = 'error';
} else {
  // Envoyer une notification Telegram
  const botToken = import.meta.env.PUBLIC_TELEGRAM_BOT_TOKEN;
  const chatId = import.meta.env.PUBLIC_TELEGRAM_CHAT_ID;
  
  const notificationMessage = `üìù Nouveau commentaire sur le blog !\n\n` +
    `üë§ Auteur : ${auteur}\n` +
    `‚≠ê Note : ${note}/5\n` +
    `üìÑ Post : ${postSlug}\n` +
    `üí¨ Commentaire : "${commentaire}"\n\n` +
    `üïê ${new Date().toLocaleString('fr-FR')}`;
  
  try {
    await fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json; charset=utf-8',
      },
      body: JSON.stringify({
        chat_id: chatId,
        text: notificationMessage,
      }),
    });
  } catch (telegramError) {
    console.error('Erreur notification Telegram:', telegramError);
    // On n'affiche pas l'erreur √† l'utilisateur, le commentaire est quand m√™me enregistr√©
  }
  
  messageDiv.textContent = 'Commentaire publi√© avec succ√®s !';
  messageDiv.className = 'success';
  form.reset();
  loadComments();
  
  setTimeout(() => {
    messageDiv.textContent = '';
    messageDiv.className = '';
  }, 3000);
}},
  
  // Charger les commentaires au chargement de la page
  loadComments());
</script>